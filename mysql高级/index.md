# MySQL高级


### 1. 存储引擎

##### 1.1. 对比MyISAM和InnoDB

| 对比项   | MyISAM                                                 | InnoDB                                                       |
| -------- | ------------------------------------------------------ | ------------------------------------------------------------ |
| 主外键   | 不支持                                                 | 支持                                                         |
| 事务     | 不支持                                                 | 支持                                                         |
| 行表锁   | 表锁,即使操作一条记录也会锁住整个表,不适合高并发的操作 | 行锁,操作时只锁一行,不对其他行有影响,适合高并发的操作        |
| 缓存     | 只缓存索引,不缓存真实数据                              | 不仅缓存索引还要缓存真实数据,对内存要求较高,而且内存大小对性能有决定性的影响 |
| 表空间   | 小                                                     | 大                                                           |
| 关注点   | 性能                                                   | 事务                                                         |
| 默认安装 | Y                                                      | Y                                                            |

##### 1.2. 阿里巴巴,淘宝用哪个?

| 产品           | 价格 | 目标                                     | 主要功能 | 是否可投入生产 |
| -------------- | ---- | ---------------------------------------- | -------- | -------------- |
| PerCona Server | 免费 | 提供XtraDB存储引擎的包装器和其他分析工具 | XtraDB   | 是             |
| MariaDB        | 免费 | 拓展MySQL以包含XtraDB和其他性能改进      | XtraDB   | 是             |
| Drizzle        | 免费 | 提供比MySQL更强大的可拓展性和性能改进    | 高可用性 | 是             |

* Percona为MySQL数据库服务器进行了改进,在功能和性能上较MySQL有着很显著的提升.该版本提升了在高负载情况下的InnoDB的性能,为DBA提供一些非常有用的性能诊断工具;另外有很多的参数和命令来控制服务器行为.
* 该公司新建了一款存储引擎交XtraDB完全可以替代InnoDB,并且在性能和并发上做的很好.
* 阿里巴巴大部分MySQL数据库其实使用的PerCona的原型加以修改.
* AliSql+AliRedis

### 2. 性能分析

##### 2.1. 性能下降SQL慢,执行时间长,等待时间长

* 查询语句写的烂
* 索引失效-单值,复合
* 关联查询太多join(设计缺陷或不得已的需求)
* 服务器调优及各个参数设置(缓冲,线程数等)

##### 2.2. 常见通用的join查询

* SQL执行顺序

  * 手写

    SELECT -> FROM -> WHERE -> GROUP BY -> HAVING -> ORDER BY -> LIMIT

  * 机读

    FROM -> ON -> WHERE -> GROUP BY -> HAVING -> SELECT -> DISTINCT -> ORDER BY -> LIMIT

  * 总结

    ![image-20220219160801991](/image-20220219160801991.png)

  

* JOIN图

​	![image-20220219161357380](/image-20220219161357380.png)

![image-20220219161428166](/image-20220219161428166.png)

##### 2.3. 索引简介

* 是什么?

  * MySQL官方对索引的定义为: 索引(Index)是帮助MySQL搞笑获取数据的数据结构.可以得到索引的本质: 索引是数据结构,索引的目的在于提高查询下效率,可以类比字典.

  * 你可以简单理解为"排好序的快速查找数据结构"

    1. 详解: 在数据之外,数据库系统还维护这满足特定查找算法的数据结构,这些数据结构以某种方式引用数据,这样就可以在这些数据结构上实现高级查找算法.这种数据结构就是索引,下图就是一种可能的索引方式示例:

    ![image-20220219163457059](/image-20220219163457059.png)

    为了加快Col2的查找,可以维护一个右边所示的二叉查找树,每个节点分别包含索引键值和一个指向对应数据记录物理地址的指针,这样就可以运用而查找树在一定的复杂度内获取到相应数据,从而快速的检索出复合条件的记录.

  * 一般来说索引本身也很大,不可能全部存储在内存中,因此索引往往以索引文件的形式存户磁盘上.

  * 我们平常所说的索引,如果没有特别指明,都是指B树(多路搜索树,并不一定是二叉的)结构组织的索引.其中聚集索引,次要索引,复合索引,前缀索引,唯一索引默认都是使用B+树索引,统称索引.当然,除了B+树这种类型的索引之外,还有哈希索引

* 优势

  * 提高数据检索的效率,降低数据库的IO成本
  * 通过索引列队数据进行排序,降低数据排序的成本,降低了CPU的消耗

* 劣势

  * 实际上索引也是一张表,该表保存了主键与索引字段,并指向实体表的记录了,所以索引列也是要占用空间的
  * 虽然索引大大提高了查询速度,同时却会降低更新表的速度,如对表进行INSERT,UIPDATE和DELETE.因为更新表时,MySQL不仅要保存数据,还要保存一下索引文件每次更新了索引列的字段,都会调整因为更新所带来的键值变化后的所有信息.

* MySQL索引分类

  * 单值索引: 即一个索引只包含单个列,一个表可以有多个单列索引
  * 唯一索引: 索引列的值必须唯一,但允许有空值
  * 复合索引: 即一个索引包含多个列

* MySQL索引结构

  * BTree索引
  * Hash索引
  * full-text全文索引
  * R-Tree索引

* 哪些情况需要创建索引

  * 主键自动建立唯一索引
  * 频繁作为查询条件的字段应该创建索引
  * 查询中与其他表关联的字段,外键关系建立索引
  * 频繁更新的字段不适合不适合创建索引,因为每次更新不单单是更新了记录还会更新索引.
  * where条件里用不到的字段不创建索引
  * 单键/组合索引的选择问题,在高并发下倾向创建组合索引
  * 查询中排序的字段,排序字段若通过索引去访问将大大提高排序素速度
  * 查询在中统计或者分组字段

* 哪些情况不需要创建索引

  * 表记录太少
  * 经常增删改的表
  * 数据重复且分布平均的表字段,因此应该只为最经常查询和最经常排序的数据列建立索引(如果某个数据列包含许多重复的内容,为他建立索引就没有太大的意义)

### 3. 性能分析

##### 3.1. MySQL Query Optimizer

> 1. MySQL中有专门负责优化SELECT语句的优化器模块,主要功能: 通过计算分析系统中收集到的统计信息,为客户端请求的Query提供他任务最优的执行计划

>2. 当客户端想MySQL请求一条Query,命令解析器模块完成请求分类,区别出事SELECT并抓饭给MySQL Query Optimizer时,MySQL Query Optimizer首先会对整条Query进行优化,处理掉一些常量表达式的预算,之间换算成常量值,并对Query中的查询条件进行简化和转换,如去掉一些无用或显而易见的条件,结构调整等,然后分析Query中的Hint,看显示Hint信息是否可以完全确定该Query的执行计划.如果没有Hint或Hint信息还不足以完全确定执行计划,则会读取所涉及对象的统计信息,根据Query进行写响应的计算分析,然后再得出最后的执行计划.

##### 3.2. MySQL的常见瓶颈

* CUP: CUP在饱和的时候一般发生在数据装入内存或磁盘上读取数据时候
* IO: 磁盘I/O瓶颈发生在装入数据远大于内存容量的时候
* 服务器硬件性能瓶颈; top,free,iostat和vmstat来查看系统的性能状态

### 4. 性能分析

##### 索引失效

* 最佳左前缀法则

​	如果索引了多列,要遵守最左前缀法则,指的是查询从索引的最左前列开始并且不跳过索引中的列

* 不要在索引列上做任何操作(计算,函数,(自动或手动)类型转换),会导致索引失效而转向全表扫描
* 存储引擎不能使用索引中范围条件右边的列
* 尽量使用覆盖索引(只访问索引的查询(索引列和查询列一致)),减少select * 
* mysql在使用不等于(!=或者<>)的时候无法使用索引会导致全表扫描
* is null ,is not null也无法使用索引
* like以通配符开头('%abc'),mysql索引失效编程全表扫描的操作
* 字符串不加单引号索引失效


