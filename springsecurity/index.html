<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>SpringSecurity - CodeSniper&#39; Blog</title><meta name="Description" content="This is My New Hugo Site"><meta property="og:title" content="SpringSecurity" />
<meta property="og:description" content="1.过滤器 security本质是一个过滤器链
  FilterSecurityInterceptor:是一个方法级的权限过滤器,基本位于过滤器链的最底部;
  ExceptionTranslationFilter:是一个异常过滤器,用来处理在认证授权过程中抛出的异常;
  UserNamePasswordAuthenticationFilter:对/Login的post请求拦截,校验表单中用户名和密码;
  2.web权限方案 1.认证   设置登录的用户名和密码
  通过配置文件
server.port=5555 spring.security.user.name=root spring.security.user.password=123456   通过配置类
@Configuration public class SecurityConfig extends WebSecurityConfigurerAdapter { @Bean PasswordEncoder passwordEncoder(){ return new BCryptPasswordEncoder(); } @Autowired private PasswordEncoder passwordEncoder; @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { String password = passwordEncoder.encode(&#34;123&#34;); auth.inMemoryAuthentication().withUser(&#34;root&#34;).password(password).roles(&#34;admin&#34;); } }   自定义编写实现类
@Configuration public class SecurityConfigTest extends WebSecurityConfigurerAdapter { @Autowired private UserDetailsService userDetailsService; @Bean PasswordEncoder passwordEncoder(){ return new BCryptPasswordEncoder(); } @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { auth." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://codesn1per.github.io/springsecurity/" /><meta property="og:image" content="https://codesn1per.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-02T02:12:28&#43;08:00" />
<meta property="article:modified_time" content="2022-04-02T02:12:28&#43;08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://codesn1per.github.io/logo.png"/>

<meta name="twitter:title" content="SpringSecurity"/>
<meta name="twitter:description" content="1.过滤器 security本质是一个过滤器链
  FilterSecurityInterceptor:是一个方法级的权限过滤器,基本位于过滤器链的最底部;
  ExceptionTranslationFilter:是一个异常过滤器,用来处理在认证授权过程中抛出的异常;
  UserNamePasswordAuthenticationFilter:对/Login的post请求拦截,校验表单中用户名和密码;
  2.web权限方案 1.认证   设置登录的用户名和密码
  通过配置文件
server.port=5555 spring.security.user.name=root spring.security.user.password=123456   通过配置类
@Configuration public class SecurityConfig extends WebSecurityConfigurerAdapter { @Bean PasswordEncoder passwordEncoder(){ return new BCryptPasswordEncoder(); } @Autowired private PasswordEncoder passwordEncoder; @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { String password = passwordEncoder.encode(&#34;123&#34;); auth.inMemoryAuthentication().withUser(&#34;root&#34;).password(password).roles(&#34;admin&#34;); } }   自定义编写实现类
@Configuration public class SecurityConfigTest extends WebSecurityConfigurerAdapter { @Autowired private UserDetailsService userDetailsService; @Bean PasswordEncoder passwordEncoder(){ return new BCryptPasswordEncoder(); } @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { auth."/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://codesn1per.github.io/springsecurity/" /><link rel="prev" href="https://codesn1per.github.io/mysql%E9%94%81%E6%9C%BA%E5%88%B6/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "SpringSecurity",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/codesn1per.github.io\/springsecurity\/"
        },"genre": "posts","keywords": "SpringSecurity","wordcount":  590 ,
        "url": "https:\/\/codesn1per.github.io\/springsecurity\/","datePublished": "2022-04-02T02:12:28+08:00","dateModified": "2022-04-02T02:12:28+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "CodeSniper"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="CodeSniper&#39; Blog"><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 博客 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="CodeSniper&#39; Blog"><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">博客</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">SpringSecurity</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>CodeSniper</a></span>&nbsp;<span class="post-category">included in <a href="/categories/%E6%A1%86%E6%9E%B6/"><i class="far fa-folder fa-fw"></i>框架</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-04-02">2022-04-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;590 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;3 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="true">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1过滤器">1.过滤器</a></li>
        <li><a href="#2web权限方案">2.web权限方案</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#1-oauth2简介">1. Oauth2简介</a>
      <ul>
        <li><a href="#11-角色">1.1 角色</a></li>
        <li><a href="#12-常用术语">1.2. 常用术语</a></li>
        <li><a href="#13-特点">1.3. 特点</a></li>
      </ul>
    </li>
    <li><a href="#2-授权模式">2. 授权模式</a>
      <ul>
        <li><a href="#21-授权码模式authorization-code">2.1 授权码模式(Authorization Code)</a></li>
        <li><a href="#22-简化授权模式">2.2 简化授权模式</a></li>
        <li><a href="#23-密码模式">2.3 密码模式</a></li>
        <li><a href="#24-客户端模式">2.4 客户端模式</a></li>
        <li><a href="#25-刷新令牌">2.5 刷新令牌</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#11-授权服务器">1.1 授权服务器</a></li>
    <li><a href="#12-流程">1.2 流程</a></li>
  </ul>

  <ul>
    <li><a href="#1-简介">1. 简介</a>
      <ul>
        <li><a href="#11-什么是jwt">1.1 什么是JWT</a></li>
        <li><a href="#12-jwt组成">1.2 JWT组成</a></li>
      </ul>
    </li>
    <li><a href="#2-jjwt简介">2. JJWT简介</a>
      <ul>
        <li><a href="#21-什么事jjwt">2.1 什么事JJWT</a></li>
        <li><a href="#22-token创建">2.2 token创建</a></li>
        <li><a href="#23-解析token">2.3 解析token</a></li>
        <li><a href="#24-token过期校验">2.4 token过期校验</a></li>
        <li><a href="#24-自定义声明">2.4 自定义声明</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h3 id="1过滤器">1.过滤器</h3>
<p><strong>security本质是一个过滤器链</strong></p>
<ol>
<li>
<p>FilterSecurityInterceptor:是一个方法级的权限过滤器,基本位于过滤器链的最底部;</p>
</li>
<li>
<p>ExceptionTranslationFilter:是一个异常过滤器,用来处理在认证授权过程中抛出的异常;</p>
</li>
<li>
<p>UserNamePasswordAuthenticationFilter:对/Login的post请求拦截,校验表单中用户名和密码;</p>
</li>
</ol>
<h3 id="2web权限方案">2.web权限方案</h3>
<h4 id="1认证">1.认证</h4>
<ol>
<li>
<p>设置登录的用户名和密码</p>
<ol>
<li>
<p>通过配置文件</p>
<div class="highlight"><pre class="chroma"><code class="language-pro" data-lang="pro"><span class="s">server</span><span class="p">.</span><span class="s">port</span><span class="o">=</span><span class="mi">5555</span>
<span class="s">spring</span><span class="p">.</span><span class="s">security</span><span class="p">.</span><span class="s">user</span><span class="p">.</span><span class="s">name</span><span class="o">=</span><span class="s">root</span>
<span class="s">spring</span><span class="p">.</span><span class="s">security</span><span class="p">.</span><span class="s">user</span><span class="p">.</span><span class="s">password</span><span class="o">=</span><span class="mi">123456</span>
</code></pre></div></li>
<li>
<p>通过配置类</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="n">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;123&#34;</span><span class="o">);</span>
        <span class="n">auth</span><span class="o">.</span><span class="na">inMemoryAuthentication</span><span class="o">().</span><span class="na">withUser</span><span class="o">(</span><span class="s">&#34;root&#34;</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="n">password</span><span class="o">).</span><span class="na">roles</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></li>
<li>
<p>自定义编写实现类</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfigTest</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserDetailsService</span> <span class="n">userDetailsService</span><span class="o">;</span>
    <span class="nd">@Bean</span>
    <span class="n">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userDetailsService</span><span class="o">).</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Service</span><span class="o">(</span><span class="s">&#34;userDetailsService&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyUserDetailService</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">role</span> <span class="o">=</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="o">(</span><span class="s">&#34;role&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="s">&#34;root&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;123&#34;</span><span class="o">),</span><span class="n">role</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><p><strong>通过查询数据库校验</strong></p>
<ol>
<li>
<p>导入依赖</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"> <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.baomidou<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mybatis-plus-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.4.3<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></li>
<li>
<p>构建实体类</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Data</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Users</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">pwd</span><span class="o">;</span>
<span class="o">}</span>

</code></pre></div></li>
<li>
<p>整合mybatis-plus,继承BaseMapper</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserMapper</span> <span class="kd">extends</span> <span class="n">BaseMapper</span><span class="o">&lt;</span><span class="n">Users</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">}</span>

</code></pre></div></li>
<li>
<p>在MyUserDetailService</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Service</span><span class="o">(</span><span class="s">&#34;userDetailsService&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyUserDetailService</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserMapper</span> <span class="n">userMapper</span><span class="o">;</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Users</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span><span class="n">name</span><span class="o">);</span>
        <span class="n">Users</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">selectOne</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">user</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UsernameNotFoundException</span><span class="o">(</span><span class="s">&#34;用户名不存在&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">role</span> <span class="o">=</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="o">(</span><span class="s">&#34;role&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span><span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getPwd</span><span class="o">()),</span><span class="n">role</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></li>
</ol>
<p><strong>自定义登录页面和权限</strong></p>
<ol>
<li>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">http</span><span class="o">.</span><span class="na">formLogin</span><span class="o">()</span> <span class="c1">//自定义自己编写的登录页面
</span><span class="c1"></span>                <span class="o">.</span><span class="na">loginPage</span><span class="o">(</span><span class="s">&#34;/login.html&#34;</span><span class="o">)</span> <span class="c1">//登录页面设置
</span><span class="c1"></span>                <span class="o">.</span><span class="na">loginProcessingUrl</span><span class="o">(</span><span class="s">&#34;/user/login&#34;</span><span class="o">)</span>  <span class="c1">//登录访问路径
</span><span class="c1"></span>                <span class="o">.</span><span class="na">defaultSuccessUrl</span><span class="o">(</span><span class="s">&#34;/test/index&#34;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span> <span class="c1">//登录成功之后,跳转路劲
</span><span class="c1"></span>                <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">,</span><span class="s">&#34;/test/hello&#34;</span><span class="o">,</span><span class="s">&#34;user/login&#34;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span> <span class="c1">//设置安歇路径可以放行
</span><span class="c1"></span>                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span> <span class="c1">//关闭csrf防护
</span><span class="c1"></span>    <span class="o">}</span>
</code></pre></div></li>
</ol>
</li>
</ol>
</li>
</ol>
<h4 id="2授权">2.授权</h4>
<p><strong>基于角色或权限进行访问控制</strong></p>
<ul>
<li>第一个方法:hasAuthority():如果当前主体具有指定的权限,则返回true,否则返回false;</li>
</ul>
<ol>
<li>
<p>在配置类设置当前访问地址有哪些权限</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"> <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/test/index&#34;</span><span class="o">).</span><span class="na">hasAnyAuthority</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">)</span> <span class="c1">//当前登录用户只有admin才能访问这个路径
</span></code></pre></div></li>
<li>
<p>在UserDetailsService,把返回User对象设置权限</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"> <span class="n">List</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">role</span> <span class="o">=</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">);</span>

</code></pre></div></li>
</ol>
<ul>
<li>
<p>第二个方法:hasAnyAuthority():如果当前的主体有任何提供的权限,则返回true,否则返回false;</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/test/index&#34;</span><span class="o">).</span><span class="na">hasAnyAuthority</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">,</span><span class="s">&#34;manage&#34;</span><span class="o">)</span>
</code></pre></div></li>
<li>
<p>第三个方法:hasRole():给定角色进行访问</p>
<ol>
<li></li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/test/index&#34;</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">&#34;sale&#34;</span><span class="o">)</span>
</code></pre></div><ol start="2">
<li>
<p>UserDetailService,把返回对象设置角色</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"> <span class="n">List</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">role</span> <span class="o">=</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="o">(</span><span class="s">&#34;admin,ROLE_sale&#34;</span><span class="o">);</span>
</code></pre></div></li>
</ol>
</li>
<li>
<p>第四个方法:hasAnyRole():具备任何一个角色就可以访问</p>
</li>
</ul>
<h4 id="3-自定义403页面">3. 自定义403页面</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">http</span><span class="o">.</span><span class="na">exceptionHandling</span><span class="o">().</span><span class="na">accessDeniedPage</span><span class="o">(</span><span class="s">&#34;/unauth.html&#34;</span><span class="o">);</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Title<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>权限不够<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div><h4 id="4-什么是csrf">4. 什么是CSRF</h4>
<p>​		CSRF:跨站请求伪造;通过伪造用户请求访问受信任站点的非法请求;</p>
<p>​		跨域: 只要网络协议,ip地址,端口中任何一个不同就是跨域请求;</p>
<p>​		客户端与服务器进行交互时,由于协议本身是无状态协议,所以引入了cookie进行记录客户端身份;在cookie中会存放session id用来识别客户端身份;在跨域的情况下,seesion id可能被第三方恶意劫持,通过这个session id向服务器发起请求时,服务端会认为这个请求是合法的;</p>
<h4 id="5-springsecurity中的csrf">5. SpringSecurity中的CSRF</h4>
<p>​		从SpringSecurity4开始CSRF防护默认开启;默认会拦截请求;进行CSRF处理;CSRF为了保证不是其他第三方网站访问,要求访问时携带参数名为_csrf值为token的内容,如果token和服务端的token匹配成功,则正常访问;</p>
<h1 id="oauth2认证">Oauth2认证</h1>
<h2 id="1-oauth2简介">1. Oauth2简介</h2>
<p>第三方认证技术方案最主要解决认证协议的通用标准问题,因为要实现跨系统认证,各系统之间要遵循一定的接口协议.</p>
<p>Oauth协议为用户资源的授权提供了安全的,开放而简易的标准.同时任何第三方都可以使用Oauth认证服务,任何服务提供商都可以实现自身的Oauth认证服务,因而Oauth是开放的.业界提供了Oauth的多种实现如PHP,JavaScript,Java等各种语言的开发包.</p>
<h3 id="11-角色">1.1 角色</h3>
<p><strong>客户端</strong></p>
<p>本身不存储资源,需要通过资源拥有者的授权去请求资源服务器的资源.</p>
<p><strong>资源拥有者</strong></p>
<p>通常为用户,也可以是应用程序,即该资源的拥有者.</p>
<p><strong>授权服务器(也称认证服务器)</strong></p>
<p>用来对资源拥有的身份进行认证,对访问资源进行授权.客户端要访问资源需要通过认证服务器由资源拥有者授权后可访问.</p>
<p><strong>资源服务器</strong></p>
<p>存储资源的服务器,比如,网站用户管理服务器存储了网站的用户信息,网站相册服务器存储了用户的相册信息,微信的资源服务存储了微信的用户信息等.客户端最终访问资源服务器获取资源信息.</p>
<h3 id="12-常用术语">1.2. 常用术语</h3>
<ul>
<li>客户凭证: 仅用于授权码授权类型,用于交换获取访问令牌和刷新令牌</li>
<li>访问令牌: 用于嗲表一个用户或服务器直接去访问受保护的资源</li>
<li>刷新令牌: 用于去授权服务器获取一个刷新访问令牌</li>
<li>BearerToken: 不管谁拿到Token都可以访问资源.</li>
<li>Proof of Prssession Token: 可以校验client是否对Token有明确的拥有权.</li>
</ul>
<h3 id="13-特点">1.3. 特点</h3>
<p>**优点: **</p>
<ul>
<li>更安全,客户端不需要接触用户密码,服务器端更易集中保护</li>
<li>广泛传播并被持续采用</li>
<li>短寿命和封装的token</li>
<li>资源服务器和授权服务器的解耦</li>
<li>集中式授权,简化客户端</li>
<li>HTTP/JSON友好,易于请求和传递token</li>
<li>考虑多种客户端架构场景</li>
<li>客户可以具有不同的信任级别</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>协议框架太宽泛,造成各种实现的兼容性和互操作性差</li>
<li>不是一个认证协议,本身并不能告诉你任何用户信息</li>
</ul>
<h2 id="2-授权模式">2. 授权模式</h2>
<h3 id="21-授权码模式authorization-code">2.1 授权码模式(Authorization Code)</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="../../static/image-20210829221743207.png"
        data-srcset="../../static/image-20210829221743207.png, ../../static/image-20210829221743207.png 1.5x, ../../static/image-20210829221743207.png 2x"
        data-sizes="auto"
        alt="../../static/image-20210829221743207.png"
        title="image-20210829221743207" /></p>
<h3 id="22-简化授权模式">2.2 简化授权模式</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="../../static/image-20210829221809041.png"
        data-srcset="../../static/image-20210829221809041.png, ../../static/image-20210829221809041.png 1.5x, ../../static/image-20210829221809041.png 2x"
        data-sizes="auto"
        alt="../../static/image-20210829221809041.png"
        title="image-20210829221809041" /></p>
<h3 id="23-密码模式">2.3 密码模式</h3>
<h3 id="24-客户端模式">2.4 客户端模式</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="../../static/image-20210829222019351.png"
        data-srcset="../../static/image-20210829222019351.png, ../../static/image-20210829222019351.png 1.5x, ../../static/image-20210829222019351.png 2x"
        data-sizes="auto"
        alt="../../static/image-20210829222019351.png"
        title="image-20210829222019351" /></p>
<h3 id="25-刷新令牌">2.5 刷新令牌</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="../../static/image-20210829222049642.png"
        data-srcset="../../static/image-20210829222049642.png, ../../static/image-20210829222049642.png 1.5x, ../../static/image-20210829222049642.png 2x"
        data-sizes="auto"
        alt="../../static/image-20210829222049642.png"
        title="image-20210829222049642" /></p>
<h1 id="spring-security-oauth2">Spring Security Oauth2</h1>
<h2 id="11-授权服务器">1.1 授权服务器</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="../../static/image-20210829222318609.png"
        data-srcset="../../static/image-20210829222318609.png, ../../static/image-20210829222318609.png 1.5x, ../../static/image-20210829222318609.png 2x"
        data-sizes="auto"
        alt="../../static/image-20210829222318609.png"
        title="image-20210829222318609" /></p>
<ul>
<li>Authorize Endpoint: 授权端点,进行授权</li>
<li>Token Endpoint: 令牌端点,经过授权拿到对应的Token</li>
<li>Introspection Endpoint: 校验端点,校验Token的合法性</li>
<li>Revocation Endpoint: 撤销端点,撤销授权</li>
</ul>
<h2 id="12-流程">1.2 流程</h2>
<ol>
<li>用户访问,此时没有token.Oauth2RestTemplate会报错.这个报错信息会被Oauth2ClientContextFilter捕获并重新定向到认证服务器</li>
<li>认证服务器通过Authorization Endpoint进行授权,并通过AuthorizationServerTokenServices生成授权码并返回给客户端</li>
<li>客户端拿到授权码去认证服务器通过Token Endpoint调用AuthorizationServerTokenServices生成Token并返回给客户端</li>
<li>客户端拿到Token去资源服务器访问资源,一般会通过Oauth2AuthenticationManager调用ResourcesServerTokenServices进行校验.校验通过可以获取资源</li>
</ol>
<h1 id="jwt">JWT</h1>
<h2 id="1-简介">1. 简介</h2>
<h3 id="11-什么是jwt">1.1 什么是JWT</h3>
<p>JSON Web Token(JWT) 是一个开放的行业标准,他定义了一种简介的,自包含的协议格式,用于在通信双方传递json对象,传递的信息经过数字签名可以被验证和信任.JWT可以使用HMAC算法或使用RSA的公钥/私钥来签名,防止被篡改.</p>
<p>JWT令牌的优点:</p>
<ol>
<li>JWT基于json,非常方便解析.</li>
<li>可以在令牌中自定义丰富的内容,易拓展.</li>
<li>通过非对称加密算法及签名技术,JWT防止篡改,安全性高.</li>
<li>资源服务使用JWT可不依赖认证服务即可完成授权.</li>
</ol>
<p>缺点:</p>
<ol>
<li>JWT令牌较长,占存储空间比较大.</li>
</ol>
<h3 id="12-jwt组成">1.2 JWT组成</h3>
<p>一个JWT实际上就是一个字符串,它由三部分组成,头部,负载与签名.</p>
<h4 id="121-头部header">1.2.1 头部(header)</h4>
<p>头部用于描述关于该JWT的最基本的信息,例如其类型以及签名使用的算法等.这也可以被表示成一个JSON对象.</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;alg&#34;</span><span class="p">:</span> <span class="s2">&#34;HS256&#34;</span>
  <span class="s2">&#34;typ&#34;</span><span class="p">:</span> <span class="s2">&#34;JWT&#34;</span>
<span class="p">}</span>
</code></pre></div><ul>
<li>typ: 是类型</li>
<li>alg: 签名的算法,这里使用的算法是HS256算法</li>
</ul>
<h4 id="122-负载payload">1.2.2 负载(Payload)</h4>
<p>第二部分师傅在,就是存放有效信息的地方.这个名字像是特指飞机上承载的货品,这些有效信息包含三个部分:</p>
<ul>
<li>标准中注册的声明(建议但不强制使用)</li>
</ul>
<pre><code>iss: jwt签发者
sub: jwt所面向的用户
aud: 接受jwt的一方
exp: jwt的过期时间,这个过期时间必须要大于签发时间
nbf: 定义在什么时间之前,该jwt都是不可用的
iat: jwt的签发时间
jti: jwt的唯一身份标识,主要用来作为一次性token,从而回避重放攻击.
</code></pre><ul>
<li>
<p>公共的声明</p>
<p>公共的声明可以添加任何的信息,一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息,因为该部分在客户端可解密</p>
</li>
<li>
<p>私有的声明</p>
<p>私有的声明是提供者和消费者所共同定义的声明,一般不建议存放敏感信息,因为base64是对称解密的,意味着该部分信息可以归类为明文信息.</p>
<p>这个指的就是自定义的claim.比如下面这个举例中的name都属于自定义的claim.这些claim跟jwt标准规定的claim区别在于: jwt规定的claim.jwt的结合搜放在拿到jwt之后,都知道怎么对这些标准的claim进行验证;而private claim不会验证,除非明确告诉接收方要对这些claim进行验证以及规则才行.</p>
<pre><code>{
&quot;sub&quot;: &quot;1234567890&quot;
&quot;name&quot;: &quot;John Doe&quot;
&quot;iat&quot;: 1516239022
}
</code></pre><p>其中sub是标准的声明,name是自定义的声明(公共的或私有的)</p>
<p>然后将其进行base64编码,得到jwt的第二部分</p>
<p><strong>提示: 声明中不要放一些敏感信息</strong></p>
</li>
</ul>
<h4 id="123-签名签名signature">1.2.3 签名,签名(signature)</h4>
<p>jwt的第三部分是一个签证信息,这个签证信息由三部分组成:</p>
<ol>
<li>header(base64后的)</li>
<li>payload(base64后的)</li>
<li>secret(盐)</li>
</ol>
<p>这个部分需要base64加密后的header和base64加密后的payload使用,连接组成的字符串啊,然后通过header中的声明的加密方式进行加盐secret组合加密,然后就构成jwt的第三部分;</p>
<p>将这三部分用.连接成一个完整的字符串,构成了最终的jwt;</p>
<p><strong>注意: secret是保存在服务器端的,jwt的签发生成也是在服务器端的,secret就是用来进行jwt的签发和jwt的验证,所以,他就是你服务器端的私钥,在任何场景都不应该流露出去.一旦客户端得知这个secret,那就意味着客户端是可以自我签发jwt了</strong></p>
<h2 id="2-jjwt简介">2. JJWT简介</h2>
<h3 id="21-什么事jjwt">2.1 什么事JJWT</h3>
<p>JJWT是一个提供端到端的JWT创建和验证的java库.永远免费和开源,JJWT很容易使用和理解.他被设计成一个以建筑为中心的流畅界面,隐藏了他的大部分复杂性;</p>
<h3 id="22-token创建">2.2 token创建</h3>
<p>导入依赖</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml">				<span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>jjwt<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>0.9.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">jwtBuilderTest</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">JwtBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="c1">//设置id {&#34;jtl&#34;:&#34;555&#34;}
</span><span class="c1"></span>                <span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">&#34;555&#34;</span><span class="o">)</span>
                <span class="c1">//签发用户
</span><span class="c1"></span>                <span class="o">.</span><span class="na">setSubject</span><span class="o">(</span><span class="s">&#34;CodeSniper&#34;</span><span class="o">)</span>
                <span class="c1">//签发时间
</span><span class="c1"></span>                <span class="o">.</span><span class="na">setIssuedAt</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="n">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS256</span><span class="o">,</span><span class="s">&#34;xxxx&#34;</span><span class="o">);</span>

        <span class="c1">//生成token
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">compact</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">split</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;\\.&#34;</span><span class="o">);</span>

        <span class="c1">//头部
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Base64Codec</span><span class="o">.</span><span class="na">BASE64</span><span class="o">.</span><span class="na">decodeToString</span><span class="o">(</span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]));</span>
        <span class="c1">//负载
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Base64Codec</span><span class="o">.</span><span class="na">BASE64</span><span class="o">.</span><span class="na">decodeToString</span><span class="o">(</span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]));</span>
        <span class="c1">//签名,乱码
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Base64Codec</span><span class="o">.</span><span class="na">BASE64</span><span class="o">.</span><span class="na">decodeToString</span><span class="o">(</span><span class="n">split</span><span class="o">[</span><span class="n">2</span><span class="o">]));</span>
    <span class="o">}</span>
</code></pre></div><h3 id="23-解析token">2.3 解析token</h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">parseToken</span><span class="o">(){</span>
	    <span class="n">String</span> <span class="n">token</span><span class="o">=</span><span class="s">&#34;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI1NTUiLCJzdWIiOiJDb2RlU25pcGVyIiwiaWF0IjoxNjMwMjE1NTkxfQ.Ztnwgh8USc1iEPez7RmHGcrH_6RLFKE60TKAzM1wOTw&#34;</span><span class="o">;</span>
	    <span class="c1">//获取claims(荷载)
</span><span class="c1"></span>        <span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="s">&#34;xxxx&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;jti:&#34;</span><span class="o">+</span><span class="n">claims</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;sub:&#34;</span><span class="o">+</span><span class="n">claims</span><span class="o">.</span><span class="na">getSubject</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;iat:&#34;</span><span class="o">+</span><span class="n">claims</span><span class="o">.</span><span class="na">getIssuedAt</span><span class="o">());</span>
</code></pre></div><h3 id="24-token过期校验">2.4 token过期校验</h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">  <span class="c1">//创建token (过期时间)
</span><span class="c1"></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">jwtBuilderTestHasExp</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">60</span> <span class="o">*</span> <span class="n">1000</span><span class="o">;</span>
        <span class="n">JwtBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="c1">//设置id {&#34;jtl&#34;:&#34;555&#34;}
</span><span class="c1"></span>                <span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">&#34;555&#34;</span><span class="o">)</span>
                <span class="c1">//签发用户
</span><span class="c1"></span>                <span class="o">.</span><span class="na">setSubject</span><span class="o">(</span><span class="s">&#34;CodeSniper&#34;</span><span class="o">)</span>
                <span class="c1">//签发时间
</span><span class="c1"></span>                <span class="o">.</span><span class="na">setIssuedAt</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="n">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS256</span><span class="o">,</span> <span class="s">&#34;xxxx&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setExpiration</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">exp</span><span class="o">));</span>

        <span class="c1">//生成token
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">compact</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">split</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;\\.&#34;</span><span class="o">);</span>

        <span class="c1">//头部
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Base64Codec</span><span class="o">.</span><span class="na">BASE64</span><span class="o">.</span><span class="na">decodeToString</span><span class="o">(</span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]));</span>
        <span class="c1">//负载
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Base64Codec</span><span class="o">.</span><span class="na">BASE64</span><span class="o">.</span><span class="na">decodeToString</span><span class="o">(</span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]));</span>
        <span class="c1">//签名,乱码
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Base64Codec</span><span class="o">.</span><span class="na">BASE64</span><span class="o">.</span><span class="na">decodeToString</span><span class="o">(</span><span class="n">split</span><span class="o">[</span><span class="n">2</span><span class="o">]));</span>
    <span class="o">}</span>

    <span class="c1">//解析token(过期时间)
</span><span class="c1"></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">parseTokenHasExp</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="s">&#34;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI1NTUiLCJzdWIiOiJDb2RlU25pcGVyIiwiaWF0IjoxNjMwMjE1NTkxfQ.Ztnwgh8USc1iEPez7RmHGcrH_6RLFKE60TKAzM1wOTw&#34;</span><span class="o">;</span>
        <span class="c1">//获取claims(荷载)
</span><span class="c1"></span>        <span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="s">&#34;xxxx&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;jti:&#34;</span> <span class="o">+</span> <span class="n">claims</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;sub:&#34;</span> <span class="o">+</span> <span class="n">claims</span><span class="o">.</span><span class="na">getSubject</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;iat:&#34;</span> <span class="o">+</span> <span class="n">claims</span><span class="o">.</span><span class="na">getIssuedAt</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;当前时间&#34;</span><span class="o">+</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="n">SimpleDateFormat</span> <span class="n">format</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">&#34;yyyy-MM-dd&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;过期时间&#34;</span><span class="o">+</span><span class="n">format</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">claims</span><span class="o">.</span><span class="na">getExpiration</span><span class="o">()));</span>
    <span class="o">}</span>
</code></pre></div><h3 id="24-自定义声明">2.4 自定义声明</h3>
<p>参数是map</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="o">.</span><span class="na">claim</span><span class="o">(</span><span class="s">&#34;logo&#34;</span><span class="o">,</span><span class="s">&#34;xxx.jpg&#34;</span><span class="o">)</span>
</code></pre></div><p>获取</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">claims</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;logo&#34;</span><span class="o">)</span>
</code></pre></div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-04-02</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/springsecurity/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/springsecurity/">SpringSecurity</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/mysql%E9%94%81%E6%9C%BA%E5%88%B6/" class="prev" rel="prev" title="MySQL锁机制"><i class="fas fa-angle-left fa-fw"></i>MySQL锁机制</a></div>
</div>
<div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">CodeSniper</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"id-1":"CodeSniper' Blog","id-2":"CodeSniper' Blog"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
